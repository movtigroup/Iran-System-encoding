# جزئیات فنی کدگذاری سیستم ایران

## بررسی کلی

سیستم ایران یک کدگذاری شخصیت قدیمی برای متن فارسی/پارسی است که قبل از اتخاذ یونی‌کد در ایران وجود داشت. برخلاف یونی‌کد، سیستم ایران از چیدمان دیداری کاراکترها به جای چیدمان منطقی استفاده می‌کند، بدین معنا که کاراکترها به ترتیبی که بصورت دیداری ظاهر می‌شوند ذخیره می‌شوند نه به ترتیبی که تایپ می‌شوند.

## نگاشت کاراکتر

مجموعه کاراکتر سیستم ایران ۲۵۶ مقدار بایت ممکن را به کاراکترهای مختلف نگاشت می‌کند:

- **0x00-0x7F**: کاراکترهای استاندارد ASCII
- **0x80-0x8F**: اعداد فارسی ۰۱۲۳۴۵۶۷۸۹ و علائم نگارشی
- **0x90-0xAF**: حروف فارسی در اشکال پیوندی مختلف
- **0xB0-0xDF**: کاراکترهای طراحی جعبه
- **0xE0-0xFF**: حروف فارسی اضافی و نمادها

## رفتار پیوندی

بر خلاف کدگذاری‌های منطقی، سیستم ایران نیاز به رسیدگی دقیق به رفتار پیوندی دارد:

- **کاراکترهای پیوندی دوطرفه**: کاراکترهایی که هم به چپ و هم به راست متصل می‌شوند (اکثر صامت‌های فارسی)
- **کاراکترهای پیوندی راست**: کاراکترهایی که فقط به کاراکتر قبلی متصل می‌شوند (الف، دال، و...)
- **کاراکترهای غیرپیوندی**: کاراکترهایی که متصل نمی‌شوند (همزه، و...)

## کاراکتر غیرپیوندی بدون عرض (ZWNJ)

کدگذاری سیستم ایران رفتار پیوندی را متفاوت از یونی‌کد مدیریت می‌کند. در برخی موارد، نیاز به یک کاراکتر ZWNJ (\u200C) برای جلوگیری از پیوند ناخواسته وجود دارد.

## الگوریتم پیاده‌سازی

پیاده‌سازی ما همان الگوریتم از کد C اصلی را تکرار می‌کند:

1. **تحلیل زمینه**: کاراکترهای قبلی و بعدی را بررسی می‌کند تا فرم دیداری صحیح را تعیین کند
2. **انتخاب فرم**: بین اشکال منزوی، ابتدایی، میانی و انتهایی بر اساس زمینه انتخاب می‌کند
3. **نگاشت کاراکتر**: کاراکترهای یونی‌کد را به مقادیر بایت سیستم ایران با استفاده از همان جدول‌ها به عنوان پیاده‌سازی C نگاشت می‌دهد

## مدیریت عدد در محل‌های مختلف

پیاده‌سازی ما مدیریت هوشمند عدد بر اساس محل فراهم می‌کند:

- هنگامی که محل به عنوان فارسی (fa) شناسایی شود، اعداد عربی به اعداد فارسی تبدیل می‌شوند
- هنگامی که محل به عنوان انگلیسی (en) شناسایی شود، اعداد به عنوان ASCII باقی می‌مانند
- الگوریتم شناسایی بر اساس فراوانی کاراکتر برای تعیین زبان اصلی استفاده می‌شود

## مرجع API

### توابع

#### `encode(text, visual_ordering=True, configuration=None)`
متن یونی‌کد را به بایت‌های کدگذاری شده سیستم ایران تبدیل می‌کند.

پارامترها:
- `text`: رشته یونی‌کد برای کدگذاری
- `visual_ordering`: آیا تبدیلات چیدمان دیداری اعمال شود
- `configuration`: پیکربندی اضافی برای شکل‌دهی متن

بازگشت: `bytes` - بایت‌های کدگذاری شده سیستم ایران

#### `decode(iransystem_bytes)`
کاراکترهای کدگذاری شده سیستم ایران را به متن یونی‌کد تبدیل می‌کند.

پارامترها:
- `iransystem_bytes`: بایت‌های کدگذاری شده سیستم ایران

بازگشت: `str` - رشته یونی‌کد رمزگشایی شده

#### `decode_hex(hex_string)`
رشته هگز نمایانگر بایت‌های سیستم ایران را به متن یونی‌کد تبدیل می‌کند.

پارامترها:
- `hex_string`: رشته هگز (با یا بدون فاصله)

بازگشت: `str` - رشته یونی‌کد رمزگشایی شده

#### `detect_locale(text)`
شناسایی می‌کند که متن عمدتاً فارسی (fa) یا انگلیسی (en) است.

پارامترها:
- `text`: متن ورودی برای تحلیل

بازگشت: `str` - 'fa' اگر فارسی غالب باشد، 'en' اگر انگلیسی غالب باشد